<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>你好，世界！</title>
  <meta name="author" content="Jason">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/favicon.png" rel="icon">
  <link href="/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="/theme/js/modernizr-2.0.js"></script>
  <script src="/theme/js/ender.js"></script>
  <script src="/theme/js/octopress.js" type="text/javascript"></script>

  <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="/">Jason Blog</a></h1>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>



<ul class="main-navigation">
    <li class="active">
    <a href="/category/python.html">Python</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">你好，世界！</h1>
      <p class="meta"><time datetime="2014-08-22T16:08:00" pubdate>五 22 八月 2014</time></p>
</header>

  <div class="entry-content"><p>你好，世界，世界，你好。</p>
<div class="highlight"><pre><span class="c1">#coding:utf-8</span>

<span class="s-Atom">&#39;&#39;&#39;</span>

<span class="s-Atom">Created on Oct 28, 2012</span>

<span class="s-Atom">@author: http://www.yihaomen.com</span>

<span class="s-Atom">&#39;&#39;&#39;</span>

<span class="s-Atom">import</span> <span class="s-Atom">socket</span><span class="p">,</span> <span class="s-Atom">threading</span><span class="p">,</span> <span class="s-Atom">os</span><span class="p">,</span> <span class="s-Atom">sys</span><span class="p">,</span> <span class="s-Atom">time</span>  

<span class="s-Atom">import</span> <span class="s-Atom">hashlib</span><span class="p">,</span> <span class="s-Atom">platform</span><span class="p">,</span> <span class="s-Atom">stat</span>  



<span class="s-Atom">listen_ip</span> <span class="o">=</span> <span class="s2">&quot;192.168.4.128&quot;</span>  

<span class="s-Atom">listen_port</span> <span class="o">=</span> <span class="m">2111</span>  

<span class="s-Atom">conn_list</span> <span class="o">=</span> <span class="p">[]</span>  

<span class="s-Atom">root_dir</span> <span class="o">=</span> <span class="s2">&quot;/home/summer/ftp&quot;</span>  

<span class="s-Atom">max_connections</span> <span class="o">=</span> <span class="m">500</span>  

<span class="s-Atom">conn_timeout</span> <span class="o">=</span> <span class="m">120</span>  



<span class="s-Atom">class</span> <span class="nv">FtpConnection</span><span class="p">(</span><span class="s-Atom">threading</span><span class="p">.</span><span class="nv">Thread</span><span class="p">)</span><span class="s-Atom">:</span>  

        <span class="s-Atom">def</span> <span class="k">__</span><span class="nf">init__</span><span class="p">(</span><span class="s-Atom">self</span><span class="p">,</span> <span class="s-Atom">fd</span><span class="p">)</span><span class="s-Atom">:</span>  

            <span class="s-Atom">threading</span><span class="p">.</span><span class="nv">Thread</span><span class="p">.</span><span class="k">__</span><span class="nf">init__</span><span class="p">(</span><span class="s-Atom">self</span><span class="p">)</span>  

            <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">fd</span> <span class="o">=</span> <span class="s-Atom">fd</span>  

            <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">running</span> <span class="o">=</span> <span class="nv">True</span>  

            <span class="s-Atom">self</span><span class="p">.</span><span class="nf">setDaemon</span><span class="p">(</span><span class="nv">True</span><span class="p">)</span>  

            <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">alive_time</span> <span class="o">=</span> <span class="s-Atom">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>  

            <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_utf8</span> <span class="o">=</span> <span class="nv">False</span>  

            <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">identified</span> <span class="o">=</span> <span class="nv">False</span>  

            <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_pasv</span> <span class="o">=</span> <span class="nv">True</span>  

            <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">username</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  

        <span class="s-Atom">def</span> <span class="nf">process</span><span class="p">(</span><span class="s-Atom">self</span><span class="p">,</span> <span class="s-Atom">cmd</span><span class="p">,</span> <span class="s-Atom">arg</span><span class="p">)</span><span class="s-Atom">:</span>  

            <span class="s-Atom">cmd</span> <span class="o">=</span> <span class="s-Atom">cmd</span><span class="p">.</span><span class="nf">upper</span><span class="p">();</span>  

            <span class="s-Atom">if</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_utf8:</span>  

                <span class="s-Atom">arg</span> <span class="o">=</span> <span class="nf">unicode</span><span class="p">(</span><span class="s-Atom">arg</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">).</span><span class="nf">encode</span><span class="p">(</span><span class="s-Atom">sys</span><span class="p">.</span><span class="nf">getfilesystemencoding</span><span class="p">())</span>  

            <span class="s-Atom">print</span> <span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">,</span> <span class="s-Atom">cmd</span><span class="p">,</span> <span class="s-Atom">arg</span><span class="p">,</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">fd</span>  

            <span class="s-Atom">#</span> <span class="nv">Ftp</span> <span class="nv">Command</span>  

            <span class="s-Atom">if</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;BYE&quot;</span> <span class="s-Atom">or</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;QUIT&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">if</span> <span class="s-Atom">os</span><span class="p">.</span><span class="s-Atom">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s-Atom">root_dir</span> <span class="o">+</span> <span class="s2">&quot;/xxftp.goodbye&quot;</span><span class="p">)</span><span class="s-Atom">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">221</span><span class="p">,</span> <span class="nf">open</span><span class="p">(</span><span class="s-Atom">root_dir</span> <span class="o">+</span> <span class="s2">&quot;/xxftp.goodbye&quot;</span><span class="p">).</span><span class="nf">read</span><span class="p">())</span>  

                <span class="nn">else</span><span class="p">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">221</span><span class="p">,</span> <span class="s2">&quot;Bye!&quot;</span><span class="p">)</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">running</span> <span class="o">=</span> <span class="nv">False</span>  

                <span class="s-Atom">return</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;USER&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">#</span> <span class="nv">Set</span> <span class="nv">Anonymous</span> <span class="nv">User</span>  

                <span class="s-Atom">if</span> <span class="s-Atom">arg</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="s-Atom">:</span> <span class="s-Atom">arg</span> <span class="o">=</span> <span class="s2">&quot;anonymous&quot;</span>  

                <span class="s-Atom">for</span> <span class="s-Atom">c</span> <span class="s-Atom">in</span> <span class="nn">arg</span><span class="p">:</span>  

                    <span class="s-Atom">if</span> <span class="o">not</span> <span class="s-Atom">c</span><span class="p">.</span><span class="nf">isalpha</span><span class="p">()</span> <span class="s-Atom">and</span> <span class="o">not</span> <span class="s-Atom">c</span><span class="p">.</span><span class="nf">isdigit</span><span class="p">()</span> <span class="s-Atom">and</span> <span class="s-Atom">c</span><span class="p">!</span><span class="s-Atom">=</span><span class="s2">&quot;_&quot;</span><span class="s-Atom">:</span>  

                        <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">530</span><span class="p">,</span> <span class="s2">&quot;Incorrect username.&quot;</span><span class="p">)</span>  

                        <span class="s-Atom">return</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">username</span> <span class="o">=</span> <span class="s-Atom">arg</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">home_dir</span> <span class="o">=</span> <span class="s-Atom">root_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">username</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">curr_dir</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">curr_dir</span><span class="p">,</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">full_path</span><span class="p">,</span> <span class="s-Atom">permission</span><span class="p">,</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">vdir_list</span><span class="p">,</span><span class="s-Atom">limit_size</span><span class="p">,</span> <span class="s-Atom">is_virtual</span> <span class="o">=</span> <span class="s-Atom">self</span><span class="p">.</span><span class="nf">parse_path</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>  

                <span class="s-Atom">if</span> <span class="o">not</span> <span class="s-Atom">os</span><span class="p">.</span><span class="s-Atom">path</span><span class="p">.</span><span class="nf">isdir</span><span class="p">(</span><span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">home_dir</span><span class="p">)</span><span class="s-Atom">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">530</span><span class="p">,</span> <span class="s2">&quot;User &quot;</span> <span class="o">+</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">username</span> <span class="o">+</span> <span class="s2">&quot; not exists.&quot;</span><span class="p">)</span>  

                    <span class="s-Atom">return</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">pass_path</span> <span class="o">=</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">home_dir</span> <span class="o">+</span> <span class="s2">&quot;/.xxftp/password&quot;</span>  

                <span class="s-Atom">if</span> <span class="s-Atom">os</span><span class="p">.</span><span class="s-Atom">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">pass_path</span><span class="p">)</span><span class="s-Atom">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">331</span><span class="p">,</span> <span class="s2">&quot;Password required for &quot;</span> <span class="o">+</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">username</span><span class="p">)</span>  

                <span class="nn">else</span><span class="p">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">230</span><span class="p">,</span> <span class="s2">&quot;Identified!&quot;</span><span class="p">)</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">identified</span> <span class="o">=</span> <span class="nv">True</span>  

                <span class="s-Atom">return</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;PASS&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">if</span> <span class="nf">open</span><span class="p">(</span><span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">pass_path</span><span class="p">).</span><span class="nf">readline</span><span class="p">().</span><span class="nf">replace</span><span class="p">(</span><span class="s-Atom">&#39;\r&#39;</span><span class="p">,</span><span class="s-Atom">&#39;&#39;</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="s-Atom">&#39;\n&#39;</span><span class="p">,</span><span class="s-Atom">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s-Atom">hashlib</span><span class="p">.</span><span class="nf">md5</span><span class="p">(</span><span class="s-Atom">arg</span><span class="p">).</span><span class="nf">hexdigest</span><span class="p">()</span><span class="s-Atom">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">230</span><span class="p">,</span> <span class="s2">&quot;Identified!&quot;</span><span class="p">)</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">identified</span> <span class="o">=</span> <span class="nv">True</span>  

                <span class="nn">else</span><span class="p">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">530</span><span class="p">,</span> <span class="s2">&quot;Not identified!&quot;</span><span class="p">)</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">identified</span> <span class="o">=</span> <span class="nv">False</span>  

                <span class="s-Atom">return</span>  

            <span class="s-Atom">elif</span> <span class="o">not</span> <span class="s-Atom">self</span><span class="p">.</span><span class="nn">identified</span><span class="p">:</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">530</span><span class="p">,</span> <span class="s2">&quot;Please login with USER and PASS.&quot;</span><span class="p">)</span>  

                <span class="s-Atom">return</span>  



            <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">alive_time</span> <span class="o">=</span> <span class="s-Atom">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>  

            <span class="s-Atom">finish</span> <span class="o">=</span> <span class="nv">True</span>  

            <span class="s-Atom">if</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;NOOP&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;TYPE&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;SYST&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="s2">&quot;UNIX&quot;</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;EPSV&quot;</span> <span class="s-Atom">or</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;PASV&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_pasv</span> <span class="o">=</span> <span class="nv">True</span>  

                <span class="nn">try</span><span class="p">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_fd</span> <span class="o">=</span> <span class="s-Atom">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="s-Atom">socket</span><span class="p">.</span><span class="nv">AF_INET</span><span class="p">,</span> <span class="s-Atom">socket</span><span class="p">.</span><span class="nv">SOCK_STREAM</span><span class="p">)</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_fd</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="s-Atom">listen_ip</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_fd</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>  

                    <span class="s-Atom">ip</span><span class="p">,</span> <span class="s-Atom">port</span> <span class="o">=</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_fd</span><span class="p">.</span><span class="nf">getsockname</span><span class="p">()</span>  

                    <span class="s-Atom">if</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;EPSV&quot;</span><span class="s-Atom">:</span>  

                        <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">229</span><span class="p">,</span> <span class="s2">&quot;Entering Extended Passive Mode (|||&quot;</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="s-Atom">port</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;|)&quot;</span><span class="p">)</span>  

                    <span class="nn">else</span><span class="p">:</span>  

                        <span class="s-Atom">ipnum</span> <span class="o">=</span> <span class="s-Atom">socket</span><span class="p">.</span><span class="nf">inet_aton</span><span class="p">(</span><span class="s-Atom">ip</span><span class="p">)</span>  

                        <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">227</span><span class="p">,</span> <span class="s2">&quot;Entering Passive Mode (%s,%u,%u).&quot;</span> <span class="c1">%  </span>

                            <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s-Atom">ip</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)),</span> <span class="p">(</span><span class="s-Atom">port&gt;&gt;</span><span class="m">8</span><span class="s-Atom">&amp;</span><span class="m">0</span><span class="s-Atom">xff</span><span class="p">),</span> <span class="p">(</span><span class="s-Atom">port&amp;</span><span class="m">0</span><span class="s-Atom">xff</span><span class="p">)))</span>  

                <span class="nn">except</span><span class="p">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">500</span><span class="p">,</span> <span class="s2">&quot;failed to create data socket.&quot;</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;EPRT&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">500</span><span class="p">,</span> <span class="s2">&quot;implement EPRT later...&quot;</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;PORT&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_pasv</span> <span class="o">=</span> <span class="nv">False</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_fd</span> <span class="o">=</span> <span class="s-Atom">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="s-Atom">socket</span><span class="p">.</span><span class="nv">AF_INET</span><span class="p">,</span> <span class="s-Atom">socket</span><span class="p">.</span><span class="nv">SOCK_STREAM</span><span class="p">)</span>  

                <span class="s-Atom">s</span> <span class="o">=</span> <span class="s-Atom">arg</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_ip</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s-Atom">s</span><span class="p">[</span><span class="s-Atom">:</span><span class="m">4</span><span class="p">])</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_port</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="s-Atom">s</span><span class="p">[</span><span class="m">4</span><span class="p">])</span><span class="o">*</span><span class="m">256</span> <span class="o">+</span> <span class="nf">int</span><span class="p">(</span><span class="s-Atom">s</span><span class="p">[</span><span class="m">5</span><span class="p">])</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;PWD&quot;</span> <span class="s-Atom">or</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;XPWD&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">if</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">curr_dir</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="s-Atom">:</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">curr_dir</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">257</span><span class="p">,</span> <span class="s-Atom">&#39;&quot;&#39;&#39;&quot;&#39;</span> <span class="o">+</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">curr_dir</span> <span class="o">+</span> <span class="s-Atom">&#39;&quot;&#39;</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;LIST&quot;</span> <span class="s-Atom">or</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;NLST&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">if</span> <span class="s-Atom">arg</span> <span class="p">!</span><span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="s-Atom">and</span> <span class="s-Atom">arg</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="s-Atom">:</span> <span class="s-Atom">arg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="s-Atom">#</span> <span class="s-Atom">omit</span> <span class="s-Atom">parameters</span>  

                <span class="s-Atom">remote</span><span class="p">,</span> <span class="s-Atom">local</span><span class="p">,</span> <span class="s-Atom">perm</span><span class="p">,</span> <span class="s-Atom">vdir_list</span><span class="p">,</span> <span class="s-Atom">limit_size</span><span class="p">,</span> <span class="s-Atom">is_virtual</span> <span class="o">=</span> <span class="s-Atom">self</span><span class="p">.</span><span class="nf">parse_path</span><span class="p">(</span><span class="s-Atom">arg</span><span class="p">)</span>  

                <span class="s-Atom">if</span> <span class="o">not</span> <span class="s-Atom">os</span><span class="p">.</span><span class="s-Atom">path</span><span class="p">.</span><span class="nf">exists</span><span class="p">(</span><span class="s-Atom">local</span><span class="p">)</span><span class="s-Atom">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">550</span><span class="p">,</span> <span class="s2">&quot;failed.&quot;</span><span class="p">)</span>  

                    <span class="s-Atom">return</span>  

                <span class="s-Atom">if</span> <span class="o">not</span> <span class="s-Atom">self</span><span class="p">.</span><span class="nf">establish</span><span class="p">()</span><span class="s-Atom">:</span> <span class="s-Atom">return</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">150</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>  

                <span class="s-Atom">for</span> <span class="s-Atom">v</span> <span class="s-Atom">in</span> <span class="s-Atom">vdir_list:</span>  

                    <span class="s-Atom">f</span> <span class="o">=</span> <span class="s-Atom">v</span><span class="p">[</span><span class="m">0</span><span class="p">]</span>  

                    <span class="s-Atom">if</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_utf8:</span>  

                        <span class="s-Atom">f</span> <span class="o">=</span> <span class="nf">unicode</span><span class="p">(</span><span class="s-Atom">f</span><span class="p">,</span> <span class="s-Atom">sys</span><span class="p">.</span><span class="nf">getfilesystemencoding</span><span class="p">()).</span><span class="nf">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>  

                    <span class="s-Atom">if</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;NLST&quot;</span><span class="s-Atom">:</span>  

                        <span class="s-Atom">info</span> <span class="o">=</span> <span class="s-Atom">f</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span>  

                    <span class="nn">else</span><span class="p">:</span>  

                        <span class="s-Atom">info</span> <span class="o">=</span> <span class="s2">&quot;d%s%s------- %04u %8s %8s %8lu %s %s\r\n&quot;</span> <span class="c1">% (  </span>

                            <span class="s2">&quot;r&quot;</span> <span class="s-Atom">if</span> <span class="s2">&quot;read&quot;</span> <span class="s-Atom">in</span> <span class="s-Atom">perm</span> <span class="s-Atom">else</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>  

                            <span class="s2">&quot;w&quot;</span> <span class="s-Atom">if</span> <span class="s2">&quot;write&quot;</span> <span class="s-Atom">in</span> <span class="s-Atom">perm</span> <span class="s-Atom">else</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>  

                            <span class="m">1</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span>  

                            <span class="s-Atom">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="s2">&quot;%b %d  %Y&quot;</span><span class="p">,</span> <span class="s-Atom">time</span><span class="p">.</span><span class="nf">localtime</span><span class="p">(</span><span class="s-Atom">time</span><span class="p">.</span><span class="nf">time</span><span class="p">())),</span>  

                            <span class="s-Atom">f</span><span class="p">)</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_fd</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s-Atom">info</span><span class="p">)</span>  

                <span class="s-Atom">for</span> <span class="s-Atom">f</span> <span class="s-Atom">in</span> <span class="s-Atom">os</span><span class="p">.</span><span class="nf">listdir</span><span class="p">(</span><span class="s-Atom">local</span><span class="p">)</span><span class="s-Atom">:</span>  

                    <span class="s-Atom">if</span> <span class="s-Atom">f</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="s-Atom">:</span> <span class="s-Atom">continue</span>  

                    <span class="s-Atom">path</span> <span class="o">=</span> <span class="s-Atom">local</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="s-Atom">f</span>  

                    <span class="s-Atom">if</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_utf8:</span>  

                        <span class="s-Atom">f</span> <span class="o">=</span> <span class="nf">unicode</span><span class="p">(</span><span class="s-Atom">f</span><span class="p">,</span> <span class="s-Atom">sys</span><span class="p">.</span><span class="nf">getfilesystemencoding</span><span class="p">()).</span><span class="nf">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>  

                    <span class="s-Atom">if</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;NLST&quot;</span><span class="s-Atom">:</span>  

                        <span class="s-Atom">info</span> <span class="o">=</span> <span class="s-Atom">f</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span>  

                    <span class="nn">else</span><span class="p">:</span>  

                        <span class="s-Atom">st</span> <span class="o">=</span> <span class="s-Atom">os</span><span class="p">.</span><span class="nf">stat</span><span class="p">(</span><span class="s-Atom">path</span><span class="p">)</span>  

                        <span class="s-Atom">info</span> <span class="o">=</span> <span class="s2">&quot;%s%s%s------- %04u %8s %8s %8lu %s %s\r\n&quot;</span> <span class="c1">% (  </span>

                            <span class="s2">&quot;-&quot;</span> <span class="s-Atom">if</span> <span class="s-Atom">os</span><span class="p">.</span><span class="s-Atom">path</span><span class="p">.</span><span class="nf">isfile</span><span class="p">(</span><span class="s-Atom">path</span><span class="p">)</span> <span class="s-Atom">else</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span>  

                            <span class="s2">&quot;r&quot;</span> <span class="s-Atom">if</span> <span class="s2">&quot;read&quot;</span> <span class="s-Atom">in</span> <span class="s-Atom">perm</span> <span class="s-Atom">else</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>  

                            <span class="s2">&quot;w&quot;</span> <span class="s-Atom">if</span> <span class="s2">&quot;write&quot;</span> <span class="s-Atom">in</span> <span class="s-Atom">perm</span> <span class="s-Atom">else</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span>  

                            <span class="m">1</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s-Atom">st</span><span class="p">[</span><span class="s-Atom">stat</span><span class="p">.</span><span class="nv">ST_SIZE</span><span class="p">],</span>  

                            <span class="s-Atom">time</span><span class="p">.</span><span class="nf">strftime</span><span class="p">(</span><span class="s2">&quot;%b %d  %Y&quot;</span><span class="p">,</span> <span class="s-Atom">time</span><span class="p">.</span><span class="nf">localtime</span><span class="p">(</span><span class="s-Atom">st</span><span class="p">[</span><span class="s-Atom">stat</span><span class="p">.</span><span class="nv">ST_MTIME</span><span class="p">])),</span>  

                            <span class="s-Atom">f</span><span class="p">)</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_fd</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s-Atom">info</span><span class="p">)</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">226</span><span class="p">,</span> <span class="s2">&quot;Limit size: &quot;</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="s-Atom">limit_size</span><span class="p">))</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_fd</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">data_fd</span> <span class="o">=</span> <span class="m">0</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;REST&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">file_pos</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="s-Atom">arg</span><span class="p">)</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">250</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;FEAT&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">features</span> <span class="o">=</span> <span class="s2">&quot;211-Features:\r\nSITES\r\nEPRT\r\nEPSV\r\nMDTM\r\nPASV\r\nREST STREAM\r\nSIZE\r\nUTF8\r\n211 End\r\n&quot;</span>  

                <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">fd</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s-Atom">features</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;OPTS&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">arg</span> <span class="o">=</span> <span class="s-Atom">arg</span><span class="p">.</span><span class="nf">upper</span><span class="p">()</span>  

                <span class="s-Atom">if</span> <span class="s-Atom">arg</span> <span class="o">==</span> <span class="s2">&quot;UTF8 ON&quot;</span><span class="s-Atom">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_utf8</span> <span class="o">=</span> <span class="nv">True</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>  

                <span class="s-Atom">elif</span> <span class="s-Atom">arg</span> <span class="o">==</span> <span class="s2">&quot;UTF8 OFF&quot;</span><span class="s-Atom">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_utf8</span> <span class="o">=</span> <span class="nv">False</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="s2">&quot;ok&quot;</span><span class="p">)</span>  

                <span class="nn">else</span><span class="p">:</span>  

                    <span class="s-Atom">self</span><span class="p">.</span><span class="nf">message</span><span class="p">(</span><span class="m">500</span><span class="p">,</span> <span class="s2">&quot;unrecognized option&quot;</span><span class="p">)</span>  

            <span class="s-Atom">elif</span> <span class="s-Atom">cmd</span> <span class="o">==</span> <span class="s2">&quot;CDUP&quot;</span><span class="s-Atom">:</span>  

                <span class="s-Atom">finish</span> <span class="o">=</span> <span class="nv">False</span>  

                <span class="s-Atom">arg</span> <span class="o">=</span> <span class="s2">&quot;..&quot;</span>  

            <span class="nn">else</span><span class="p">:</span>  

                <span class="s-Atom">finish</span> <span class="o">=</span> <span class="nv">False</span>  

            <span class="s-Atom">if</span> <span class="nn">finish</span><span class="p">:</span> <span class="s-Atom">return</span>  

            <span class="s-Atom">#</span> <span class="nv">Parse</span> <span class="nf">argument</span> <span class="p">(</span> <span class="nv">It</span><span class="s-Atom">&#39;s a path )  </span>

<span class="s-Atom">            if arg == &quot;&quot;:  </span>

<span class="s-Atom">                self.message(500, &quot;where&#39;s</span> <span class="s-Atom">my</span> <span class="s-Atom">argument?</span><span class="s2">&quot;)  </span>

<span class="s2">                return  </span>

<span class="s2">            remote, local, permission, vdir_list, limit_size, is_virtual = self.parse_path(arg)  </span>

<span class="s2">            # can not do anything to virtual directory  </span>

<span class="s2">            if is_virtual: permission = &quot;</span><span class="s-Atom">none</span><span class="s2">&quot;  </span>

<span class="s2">            can_read, can_write, can_modify = &quot;</span><span class="s-Atom">read</span><span class="s2">&quot; in permission, &quot;</span><span class="s-Atom">write</span><span class="s2">&quot; in permission, &quot;</span><span class="s-Atom">modify</span><span class="s2">&quot; in permission  </span>

<span class="s2">            newpath = local  </span>

<span class="s2">            try:  </span>

<span class="s2">                if cmd == &quot;</span><span class="nv">CWD</span><span class="s2">&quot;:  </span>

<span class="s2">                    if(os.path.isdir(newpath)):  </span>

<span class="s2">                        self.curr_dir = remote  </span>

<span class="s2">                        self.full_path = newpath  </span>

<span class="s2">                        self.message(250, &#39;&quot;</span><span class="s-Atom">&#39;&#39;</span><span class="s2">&quot;&#39; + remote + &#39;&quot;</span><span class="s-Atom">&#39;)  </span>

<span class="s-Atom">                    else:  </span>

<span class="s-Atom">                        self.message(550, &quot;failed&quot;)  </span>

<span class="s-Atom">                elif cmd == &quot;MDTM&quot;:  </span>

<span class="s-Atom">                    if os.path.exists(newpath):  </span>

<span class="s-Atom">                        self.message(213, time.strftime(&quot;%Y%m%d%I%M%S&quot;, time.localtime(  </span>

<span class="s-Atom">                            os.path.getmtime(newpath))))  </span>

<span class="s-Atom">                    else:  </span>

<span class="s-Atom">                        self.message(550, &quot;failed&quot;)  </span>

<span class="s-Atom">                elif cmd == &quot;SIZE&quot;:  </span>

<span class="s-Atom">                    self.message(231, os.path.getsize(newpath))  </span>

<span class="s-Atom">                elif cmd == &quot;XMKD&quot; or cmd == &quot;MKD&quot;:  </span>

<span class="s-Atom">                    if not can_modify:  </span>

<span class="s-Atom">                        self.message(550, &quot;permission denied.&quot;)  </span>

<span class="s-Atom">                        return  </span>

<span class="s-Atom">                    os.mkdir(newpath)  </span>

<span class="s-Atom">                    self.message(250, &quot;ok&quot;)  </span>

<span class="s-Atom">                elif cmd == &quot;RNFR&quot;:  </span>

<span class="s-Atom">                    if not can_modify:  </span>

<span class="s-Atom">                        self.message(550, &quot;permission denied.&quot;)  </span>

<span class="s-Atom">                        return  </span>

<span class="s-Atom">                    self.temp_path = newpath  </span>

<span class="s-Atom">                    self.message(350, &quot;rename from &quot; + remote)  </span>

<span class="s-Atom">                elif cmd == &quot;RNTO&quot;:  </span>

<span class="s-Atom">                    os.rename(self.temp_path, newpath)  </span>

<span class="s-Atom">                    self.message(250, &quot;RNTO to &quot; + remote)  </span>

<span class="s-Atom">                elif cmd == &quot;XRMD&quot; or cmd == &quot;RMD&quot;:  </span>

<span class="s-Atom">                    if not can_modify:  </span>

<span class="s-Atom">                        self.message(550, &quot;permission denied.&quot;)  </span>

<span class="s-Atom">                        return  </span>

<span class="s-Atom">                    os.rmdir(newpath)  </span>

<span class="s-Atom">                    self.message(250, &quot;ok&quot;)  </span>

<span class="s-Atom">                elif cmd == &quot;DELE&quot;:  </span>

<span class="s-Atom">                    if not can_modify:  </span>

<span class="s-Atom">                        self.message(550, &quot;permission denied.&quot;)  </span>

<span class="s-Atom">                        return  </span>

<span class="s-Atom">                    os.remove(newpath)  </span>

<span class="s-Atom">                    self.message(250, &quot;ok&quot;)  </span>

<span class="s-Atom">                elif cmd == &quot;RETR&quot;:  </span>

<span class="s-Atom">                    if not os.path.isfile(newpath):  </span>

<span class="s-Atom">                        self.message(550, &quot;failed&quot;)  </span>

<span class="s-Atom">                        return  </span>

<span class="s-Atom">                    if not can_read:  </span>

<span class="s-Atom">                        self.message(550, &quot;permission denied.&quot;)  </span>

<span class="s-Atom">                        return  </span>

<span class="s-Atom">                    if not self.establish(): return  </span>

<span class="s-Atom">                    self.message(150, &quot;ok&quot;)  </span>

<span class="s-Atom">                    f = open(newpath, &quot;rb&quot;)  </span>

<span class="s-Atom">                    while self.running:  </span>

<span class="s-Atom">                        self.alive_time = time.time()  </span>

<span class="s-Atom">                        data = f.read(8192)  </span>

<span class="s-Atom">                        if len(data) == 0: break  </span>

<span class="s-Atom">                        self.data_fd.send(data)  </span>

<span class="s-Atom">                    f.close()  </span>

<span class="s-Atom">                    self.data_fd.close()  </span>

<span class="s-Atom">                    self.data_fd = 0  </span>

<span class="s-Atom">                    self.message(226, &quot;ok&quot;)  </span>

<span class="s-Atom">                elif cmd == &quot;STOR&quot; or cmd == &quot;APPE&quot;:  </span>

<span class="s-Atom">                    if not can_write:  </span>

<span class="s-Atom">                        self.message(550, &quot;permission denied.&quot;)  </span>

<span class="s-Atom">                        return  </span>

<span class="s-Atom">                    if os.path.exists(newpath) and not can_modify:  </span>

<span class="s-Atom">                        self.message(550, &quot;permission denied.&quot;)  </span>

<span class="s-Atom">                        return  </span>

<span class="s-Atom">                    # Check space size remained!  </span>

<span class="s-Atom">                    used_size = 0  </span>

<span class="s-Atom">                    if limit_size &gt; 0:  </span>

<span class="s-Atom">                        used_size = self.get_dir_size(os.path.dirname(newpath))  </span>

<span class="s-Atom">                    if not self.establish(): return  </span>

<span class="s-Atom">                    self.message(150, &quot;ok&quot;)  </span>

<span class="s-Atom">                    f = open(newpath, (&quot;ab&quot; if cmd == &quot;APPE&quot; else &quot;wb&quot;) )  </span>

<span class="s-Atom">                    while self.running:  </span>

<span class="s-Atom">                        self.alive_time = time.time()  </span>

<span class="s-Atom">                        data = self.data_fd.recv(8192)  </span>

<span class="s-Atom">                        if len(data) == 0: break  </span>

<span class="s-Atom">                        if limit_size &gt; 0:  </span>

<span class="s-Atom">                            used_size = used_size + len(data)  </span>

<span class="s-Atom">                            if used_size &gt; limit_size: break  </span>

<span class="s-Atom">                        f.write(data)  </span>

<span class="s-Atom">                    f.close()  </span>

<span class="s-Atom">                    self.data_fd.close()  </span>

<span class="s-Atom">                    self.data_fd = 0  </span>

<span class="s-Atom">                    if limit_size &gt; 0 and used_size &gt; limit_size:  </span>

<span class="s-Atom">                        self.message(550, &quot;Exceeding user space limit: &quot; + str(limit_size) + &quot; bytes&quot;)  </span>

<span class="s-Atom">                    else:  </span>

<span class="s-Atom">                        self.message(226, &quot;ok&quot;)  </span>

<span class="s-Atom">                else:  </span>

<span class="s-Atom">                    self.message(500, cmd + &quot; not implemented&quot;)  </span>

<span class="s-Atom">            except:  </span>

<span class="s-Atom">                self.message(550, &quot;failed.&quot;)  </span>



<span class="s-Atom">        def establish(self):  </span>

<span class="s-Atom">            if self.data_fd == 0:  </span>

<span class="s-Atom">                self.message(500, &quot;no data connection&quot;)  </span>

<span class="s-Atom">                return False  </span>

<span class="s-Atom">            if self.option_pasv:  </span>

<span class="s-Atom">                fd = self.data_fd.accept()[0]  </span>

<span class="s-Atom">                self.data_fd.close()  </span>

<span class="s-Atom">                self.data_fd = fd  </span>

<span class="s-Atom">            else:  </span>

<span class="s-Atom">                try:  </span>

<span class="s-Atom">                    self.data_fd.connect((self.data_ip, self.data_port))  </span>

<span class="s-Atom">                except:  </span>

<span class="s-Atom">                    self.message(500, &quot;failed to establish data connection&quot;)  </span>

<span class="s-Atom">                    return False  </span>

<span class="s-Atom">            return True  </span>



<span class="s-Atom">        def read_virtual(self, path):  </span>

<span class="s-Atom">            vdir_list = []  </span>

<span class="s-Atom">            path = path + &quot;/.xxftp/virtual&quot;  </span>

<span class="s-Atom">            if os.path.isfile(path):  </span>

<span class="s-Atom">                for v in open(path, &quot;r&quot;).readlines():  </span>

<span class="s-Atom">                    items = v.split()  </span>

<span class="s-Atom">                    items[1] = items[1].replace(&quot;$root&quot;, root_dir)  </span>

<span class="s-Atom">                    vdir_list.append(items)  </span>

<span class="s-Atom">            return vdir_list  </span>



<span class="s-Atom">        def get_dir_size(self, folder):  </span>

<span class="s-Atom">            size = 0  </span>

<span class="s-Atom">            for path, dirs, files in os.walk(folder):  </span>

<span class="s-Atom">                for f in files:  </span>

<span class="s-Atom">                    size += os.path.getsize(os.path.join(path, f))  </span>

<span class="s-Atom">            return size  </span>



<span class="s-Atom">        def read_size(self, path):  </span>

<span class="s-Atom">            size = 0  </span>

<span class="s-Atom">            path = path + &quot;/.xxftp/size&quot;  </span>

<span class="s-Atom">            if os.path.isfile(path):  </span>

<span class="s-Atom">                size = int(open(path, &quot;r&quot;).readline())  </span>

<span class="s-Atom">            return size  </span>



<span class="s-Atom">        def read_permission(self, path):  </span>

<span class="s-Atom">            permission = &quot;read,write,modify&quot;  </span>

<span class="s-Atom">            path = path + &quot;/.xxftp/permission&quot;  </span>

<span class="s-Atom">            if os.path.isfile(path):  </span>

<span class="s-Atom">                permission = open(path, &quot;r&quot;).readline()  </span>

<span class="s-Atom">            return permission  </span>



<span class="s-Atom">        def parse_path(self, path):  </span>

<span class="s-Atom">            if path == &quot;&quot;: path = &quot;.&quot;  </span>

<span class="s-Atom">            if path[0] != &quot;/&quot;:  </span>

<span class="s-Atom">                path = self.curr_dir + &quot;/&quot; + path  </span>

<span class="s-Atom">            s = os.path.normpath(path).replace(&quot;\\&quot;, &quot;/&quot;).split(&quot;/&quot;)  </span>

<span class="s-Atom">            local = self.home_dir  </span>

<span class="s-Atom">            # reset directory permission  </span>

<span class="s-Atom">            vdir_list = self.read_virtual(local)  </span>

<span class="s-Atom">            limit_size = self.read_size(local)  </span>

<span class="s-Atom">            permission = self.read_permission(local)  </span>

<span class="s-Atom">            remote = &quot;&quot;  </span>

<span class="s-Atom">            is_virtual = False  </span>

<span class="s-Atom">            for name in s:  </span>

<span class="s-Atom">                name = name.lstrip(&quot;.&quot;)  </span>

<span class="s-Atom">                if name == &quot;&quot;: continue  </span>

<span class="s-Atom">                remote = remote + &quot;/&quot; + name  </span>

<span class="s-Atom">                is_virtual = False  </span>

<span class="s-Atom">                for v in vdir_list:  </span>

<span class="s-Atom">                    if v[0] == name:  </span>

<span class="s-Atom">                        permission = v[2]  </span>

<span class="s-Atom">                        local = v[1]  </span>

<span class="s-Atom">                        limit_size = self.read_size(local)  </span>

<span class="s-Atom">                        is_virtual = True  </span>

<span class="s-Atom">                if not is_virtual: local = local + &quot;/&quot; + name  </span>

<span class="s-Atom">                vdir_list = self.read_virtual(local)  </span>

<span class="s-Atom">            return (remote, local, permission, vdir_list, limit_size, is_virtual)  </span>



<span class="s-Atom">        def run(self):  </span>

<span class="s-Atom">            &#39;&#39;&#39;&#39;&#39;</span> <span class="nv">Connection</span> <span class="nv">Process</span> <span class="s-Atom">&#39;&#39;&#39;  </span>

<span class="s-Atom">            try:  </span>

<span class="s-Atom">                if len(conn_list) &gt; max_connections:  </span>

<span class="s-Atom">                    self.message(500, &quot;too many connections!&quot;)  </span>

<span class="s-Atom">                    self.fd.close()  </span>

<span class="s-Atom">                    self.running = False  </span>

<span class="s-Atom">                    return  </span>

<span class="s-Atom">                # Welcome Message  </span>

<span class="s-Atom">                if os.path.exists(root_dir + &quot;/xxftp.welcome&quot;):  </span>

<span class="s-Atom">                    self.message(220, open(root_dir + &quot;/xxftp.welcome&quot;).read())  </span>

<span class="s-Atom">                else:  </span>

<span class="s-Atom">                    self.message(220, &quot;xxftp(Python) www.yihaomen.com&quot;)  </span>

<span class="s-Atom">                # Command Loop  </span>

<span class="s-Atom">                line = &quot;&quot;  </span>

<span class="s-Atom">                while self.running:  </span>

<span class="s-Atom">                    data = self.fd.recv(4096)  </span>

<span class="s-Atom">                    if len(data) == 0: break  </span>

<span class="s-Atom">                    line += data  </span>

<span class="s-Atom">                    if line[-2:] != &quot;\r\n&quot;: continue  </span>

<span class="s-Atom">                    line = line[:-2]  </span>

<span class="s-Atom">                    space = line.find(&quot; &quot;)  </span>

<span class="s-Atom">                    if space == -1:  </span>

<span class="s-Atom">                        self.process(line, &quot;&quot;)  </span>

<span class="s-Atom">                    else:  </span>

<span class="s-Atom">                        self.process(line[:space], line[space+1:])  </span>

<span class="s-Atom">                    line = &quot;&quot;  </span>

<span class="s-Atom">            except:  </span>

<span class="s-Atom">                print &quot;error&quot;, sys.exc_info()  </span>

<span class="s-Atom">            self.running = False  </span>

<span class="s-Atom">            self.fd.close()  </span>

<span class="s-Atom">            print &quot;connection end&quot;, self.fd, &quot;user&quot;, self.username  </span>



<span class="s-Atom">        def message(self, code, s):  </span>

<span class="s-Atom">            &#39;&#39;&#39;&#39;&#39;</span> <span class="nv">Send</span> <span class="nv">Ftp</span> <span class="nv">Message</span> <span class="s-Atom">&#39;&#39;</span><span class="err">&#39;</span>  

            <span class="s-Atom">s</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="s-Atom">s</span><span class="p">).</span><span class="nf">replace</span><span class="p">(</span><span class="s2">&quot;\r&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>  

            <span class="s-Atom">ss</span> <span class="o">=</span> <span class="s-Atom">s</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">)</span>  

            <span class="s-Atom">if</span> <span class="nf">len</span><span class="p">(</span><span class="s-Atom">ss</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">1</span><span class="s-Atom">:</span>  

                <span class="s-Atom">r</span> <span class="o">=</span> <span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="s-Atom">code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;\r\n&quot;</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="s-Atom">code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span><span class="p">).</span><span class="nf">join</span><span class="p">(</span><span class="s-Atom">ss</span><span class="p">[:-</span><span class="m">1</span><span class="p">])</span>  

                <span class="s-Atom">r</span> <span class="s-Atom">+=</span> <span class="s2">&quot;\r\n&quot;</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="s-Atom">code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s-Atom">ss</span><span class="p">[</span><span class="o">-</span><span class="m">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span>  

            <span class="nn">else</span><span class="p">:</span>  

                <span class="s-Atom">r</span> <span class="o">=</span> <span class="nf">str</span><span class="p">(</span><span class="s-Atom">code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s-Atom">ss</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\r\n&quot;</span>  

            <span class="s-Atom">if</span> <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">option_utf8:</span>  

                <span class="s-Atom">r</span> <span class="o">=</span> <span class="nf">unicode</span><span class="p">(</span><span class="s-Atom">r</span><span class="p">,</span> <span class="s-Atom">sys</span><span class="p">.</span><span class="nf">getfilesystemencoding</span><span class="p">()).</span><span class="nf">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>  

            <span class="s-Atom">self</span><span class="p">.</span><span class="s-Atom">fd</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s-Atom">r</span><span class="p">)</span>  



<span class="s-Atom">def</span> <span class="nf">server_listen</span><span class="p">()</span><span class="s-Atom">:</span>  

        <span class="s-Atom">global</span> <span class="s-Atom">conn_list</span>  

        <span class="s-Atom">listen_fd</span> <span class="o">=</span> <span class="s-Atom">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="s-Atom">socket</span><span class="p">.</span><span class="nv">AF_INET</span><span class="p">,</span> <span class="s-Atom">socket</span><span class="p">.</span><span class="nv">SOCK_STREAM</span><span class="p">)</span>  

        <span class="s-Atom">listen_fd</span><span class="p">.</span><span class="nf">setsockopt</span><span class="p">(</span><span class="s-Atom">socket</span><span class="p">.</span><span class="nv">SOL_SOCKET</span><span class="p">,</span> <span class="s-Atom">socket</span><span class="p">.</span><span class="nv">SO_REUSEADDR</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>  

        <span class="s-Atom">listen_fd</span><span class="p">.</span><span class="nf">bind</span><span class="p">((</span><span class="s-Atom">listen_ip</span><span class="p">,</span> <span class="s-Atom">listen_port</span><span class="p">))</span>  

        <span class="s-Atom">listen_fd</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="m">1024</span><span class="p">)</span>  

        <span class="s-Atom">conn_lock</span> <span class="o">=</span> <span class="s-Atom">threading</span><span class="p">.</span><span class="nv">Lock</span><span class="p">()</span>  

        <span class="s-Atom">print</span> <span class="s2">&quot;ftpd is listening on &quot;</span><span class="p">,</span> <span class="s-Atom">listen_ip</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nf">str</span><span class="p">(</span><span class="s-Atom">listen_port</span><span class="p">)</span>  



        <span class="s-Atom">while</span> <span class="nv">True</span><span class="s-Atom">:</span>  

            <span class="s-Atom">conn_fd</span><span class="p">,</span> <span class="s-Atom">remote_addr</span> <span class="o">=</span> <span class="s-Atom">listen_fd</span><span class="p">.</span><span class="nf">accept</span><span class="p">()</span>  

            <span class="s-Atom">print</span> <span class="s2">&quot;connection from &quot;</span><span class="p">,</span> <span class="s-Atom">remote_addr</span><span class="p">,</span> <span class="s2">&quot;conn_list&quot;</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="s-Atom">conn_list</span><span class="p">)</span>  

            <span class="s-Atom">conn</span> <span class="o">=</span> <span class="nv">FtpConnection</span><span class="p">(</span><span class="s-Atom">conn_fd</span><span class="p">)</span>  

            <span class="s-Atom">conn</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>  



            <span class="s-Atom">conn_lock</span><span class="p">.</span><span class="nf">acquire</span><span class="p">()</span>  

            <span class="s-Atom">conn_list</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="s-Atom">conn</span><span class="p">)</span>  

            <span class="s-Atom">#</span> <span class="s-Atom">check</span> <span class="s-Atom">timeout</span>  

            <span class="nn">try</span><span class="p">:</span>  

                <span class="s-Atom">curr_time</span> <span class="o">=</span> <span class="s-Atom">time</span><span class="p">.</span><span class="nf">time</span><span class="p">()</span>  

                <span class="s-Atom">for</span> <span class="s-Atom">conn</span> <span class="s-Atom">in</span> <span class="s-Atom">conn_list:</span>  

                    <span class="s-Atom">if</span> <span class="nf">int</span><span class="p">(</span><span class="s-Atom">curr_time</span> <span class="o">-</span> <span class="s-Atom">conn</span><span class="p">.</span><span class="s-Atom">alive_time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="s-Atom">conn_timeout:</span>  

                        <span class="s-Atom">if</span> <span class="s-Atom">conn</span><span class="p">.</span><span class="s-Atom">running</span> <span class="o">==</span> <span class="nv">True</span><span class="s-Atom">:</span>  

                            <span class="s-Atom">conn</span><span class="p">.</span><span class="s-Atom">fd</span><span class="p">.</span><span class="nf">shutdown</span><span class="p">(</span><span class="s-Atom">socket</span><span class="p">.</span><span class="nv">SHUT_RDWR</span><span class="p">)</span>  

                        <span class="s-Atom">conn</span><span class="p">.</span><span class="s-Atom">running</span> <span class="o">=</span> <span class="nv">False</span>  

                <span class="s-Atom">conn_list</span> <span class="o">=</span> <span class="p">[</span><span class="s-Atom">conn</span> <span class="s-Atom">for</span> <span class="s-Atom">conn</span> <span class="s-Atom">in</span> <span class="s-Atom">conn_list</span> <span class="s-Atom">if</span> <span class="s-Atom">conn</span><span class="p">.</span><span class="s-Atom">running</span><span class="p">]</span>  

            <span class="nn">except</span><span class="p">:</span>  

                <span class="s-Atom">print</span> <span class="s-Atom">sys</span><span class="p">.</span><span class="nf">exc_info</span><span class="p">()</span>  

            <span class="s-Atom">conn_lock</span><span class="p">.</span><span class="nf">release</span><span class="p">()</span>  



<span class="s-Atom">def</span> <span class="nf">main</span><span class="p">()</span><span class="s-Atom">:</span>  

    <span class="nf">server_listen</span><span class="p">()</span>  



<span class="s-Atom">if</span> <span class="k">__</span><span class="s-Atom">name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="s-Atom">:</span>  

    <span class="nf">main</span><span class="p">()</span> 
</pre></div></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Jason</span>
  </span>
<time datetime="2014-08-22T16:08:00" pubdate>五 22 八月 2014</time>  <span class="categories">
    <a class="category" href="/tag/python.html">python</a>
  </span>
</p><div class="sharing">
</div>    </footer>
  </article>

</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="/ni-hao-shi-jie.html">你好，世界！</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="/category/python.html">Python</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="/tag/python.html">python</a>  </section>


    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="#" target="_blank">You can add links in your config file</a></li>
            <li><a href="#" target="_blank">Another social link</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
            <li><a href="http://python.org/" target="_blank">Python.org</a></li>
            <li><a href="http://jinja.pocoo.org/" target="_blank">Jinja2</a></li>
            <li><a href="#" target="_blank">You can modify those links in your config file</a></li>
        </ul>
    </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Jason -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
</body>
</html>